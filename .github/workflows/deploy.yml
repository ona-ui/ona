name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: VPS-ONA

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Rolling Deploy to VPS
        uses: appleboy/ssh-action@v1.2.2
        with:
          host:     ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key:      ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            echo "ğŸš€ DÃ©but du dÃ©ploiement rolling..."
            
            cd /var/www/ona
            
            # RÃ©cupÃ©rer les derniÃ¨res modifications
            echo "ğŸ“¥ RÃ©cupÃ©ration des modifications..."
            sudo git pull origin main
            
            # Fonction pour attendre qu'un service soit healthy
            wait_for_healthy() {
              local service=$1
              local max_attempts=30
              local attempt=1
              
              echo "â³ Attente que $service soit healthy..."
              
              while [ $attempt -le $max_attempts ]; do
                if sudo docker compose ps --format json | jq -r ".[] | select(.Service==\"$service\") | .Health" | grep -q "healthy"; then
                  echo "âœ… $service est healthy (tentative $attempt/$max_attempts)"
                  return 0
                fi
                
                echo "ğŸ”„ Tentative $attempt/$max_attempts - $service pas encore healthy..."
                sleep 10
                attempt=$((attempt + 1))
              done
              
              echo "âŒ $service n'est pas healthy aprÃ¨s $max_attempts tentatives"
              return 1
            }
            
            # DÃ©ploiement rolling du backend
            echo "ğŸ”§ DÃ©ploiement rolling du backend..."
            
            # Construire la nouvelle image backend
            echo "ğŸ—ï¸ Construction de la nouvelle image backend..."
            sudo docker compose build --no-cache backend
            
            # DÃ©marrer un nouveau conteneur backend en parallÃ¨le
            echo "ğŸš€ DÃ©marrage du nouveau backend..."
            sudo docker compose up -d --no-deps --scale backend=2 backend
            
            # Attendre que le nouveau backend soit healthy
            sleep 20
            if ! wait_for_healthy "backend"; then
              echo "âŒ Rollback du backend..."
              sudo docker compose up -d --no-deps --scale backend=1 backend
              exit 1
            fi
            
            # ArrÃªter l'ancien conteneur backend
            echo "ğŸ”„ Remplacement de l'ancien backend..."
            sudo docker compose up -d --no-deps --scale backend=1 backend
            
            echo "âœ… Backend dÃ©ployÃ© avec succÃ¨s"
            
            # Attendre un peu avant le frontend
            sleep 10
            
            # DÃ©ploiement rolling du frontend
            echo "ğŸ”§ DÃ©ploiement rolling du frontend..."
            
            # Construire la nouvelle image frontend
            echo "ğŸ—ï¸ Construction de la nouvelle image frontend..."
            sudo docker compose build --no-cache frontend
            
            # DÃ©marrer un nouveau conteneur frontend en parallÃ¨le
            echo "ğŸš€ DÃ©marrage du nouveau frontend..."
            sudo docker compose up -d --no-deps --scale frontend=2 frontend
            
            # Attendre que le nouveau frontend soit healthy
            sleep 20
            if ! wait_for_healthy "frontend"; then
              echo "âŒ Rollback du frontend..."
              sudo docker compose up -d --no-deps --scale frontend=1 frontend
              exit 1
            fi
            
            # ArrÃªter l'ancien conteneur frontend
            echo "ğŸ”„ Remplacement de l'ancien frontend..."
            sudo docker compose up -d --no-deps --scale frontend=1 frontend
            
            echo "âœ… Frontend dÃ©ployÃ© avec succÃ¨s"
            
            # Nettoyage
            echo "ğŸ§¹ Nettoyage des images inutilisÃ©es..."
            sudo docker system prune -f
            
            # Statut final
            echo "ğŸ“Š Statut final des services:"
            sudo docker compose ps
            
            echo "ğŸ‰ DÃ©ploiement rolling terminÃ© avec succÃ¨s !"
