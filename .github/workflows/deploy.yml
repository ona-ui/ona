name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: VPS-ONA

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Rolling Deploy to VPS
        uses: appleboy/ssh-action@v1.2.2
        with:
          host:     ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key:      ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            echo "ğŸš€ DÃ©but du dÃ©ploiement rolling..."
            
            cd /var/www/ona
            
            # RÃ©cupÃ©rer les derniÃ¨res modifications
            echo "ğŸ“¥ RÃ©cupÃ©ration des modifications..."
            sudo git pull origin main
            
            # Fonction pour attendre qu'un service soit healthy
            wait_for_healthy() {
              local service=$1
              local max_attempts=12
              local attempt=1
              
              echo "â³ Attente que $service soit healthy..."
              
              while [ $attempt -le $max_attempts ]; do
              health_status=$(sudo docker inspect --format='{{.State.Health.Status}}' $(sudo docker compose ps -q $service) 2>/dev/null || echo "starting")
                
                if [ "$health_status" = "healthy" ]; then
                  echo "âœ… $service est healthy (tentative $attempt/$max_attempts)"
                  return 0
                elif [ "$health_status" = "unhealthy" ]; then
                  echo "âŒ $service est unhealthy"
                  return 1
                fi
                
                echo "ğŸ”„ Tentative $attempt/$max_attempts - $service: $health_status"
                sleep 15
                attempt=$((attempt + 1))
              done
              
              echo "âŒ $service n'est pas healthy aprÃ¨s $max_attempts tentatives"
              sudo docker compose logs --tail=10 $service
              return 1
            }
            
            # Fonction pour dÃ©ployer un service avec rolling update
            deploy_service() {
              local service=$1
              echo "ğŸ”§ DÃ©ploiement rolling de $service..."
              
              # Construire la nouvelle image
              echo "ğŸ—ï¸ Construction de la nouvelle image $service..."
              sudo docker compose build --no-cache $service
              
              # CrÃ©er un nouveau conteneur temporaire
              echo "ğŸš€ DÃ©marrage du nouveau $service..."
              sudo docker compose up -d --no-deps --scale $service=2 $service
              
              # Attendre que le nouveau service soit healthy
              echo "â³ Attente que le nouveau $service soit prÃªt..."
              sleep 30
              
              if ! wait_for_healthy "$service"; then
                echo "âŒ Rollback de $service..."
                sudo docker compose up -d --no-deps --scale $service=1 $service
                return 1
              fi
              
              # Remplacer l'ancien conteneur
              echo "ğŸ”„ Remplacement de l'ancien $service..."
              sudo docker compose up -d --no-deps --scale $service=1 $service
              
              # VÃ©rification finale
              sleep 10
              if ! wait_for_healthy "$service"; then
                echo "âŒ Le $service n'est pas stable aprÃ¨s remplacement"
                return 1
              fi
              
              echo "âœ… $service dÃ©ployÃ© avec succÃ¨s"
              return 0
            }
            
            # DÃ©ploiement du backend
            if ! deploy_service "backend"; then
              echo "âŒ Ã‰chec du dÃ©ploiement du backend"
              exit 1
            fi
            
            # Attendre avant le frontend
            sleep 15
            
            # DÃ©ploiement du frontend
            if ! deploy_service "frontend"; then
              echo "âŒ Ã‰chec du dÃ©ploiement du frontend"
              exit 1
            fi
            
            # Nettoyage
            echo "ğŸ§¹ Nettoyage des images inutilisÃ©es..."
            sudo docker system prune -f
            
            # Statut final
            echo "ğŸ“Š Statut final des services:"
            sudo docker compose ps
            
            echo "ğŸ‰ DÃ©ploiement rolling terminÃ© avec succÃ¨s !"
